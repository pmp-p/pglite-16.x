"use strict";var q=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var V=s=>{throw TypeError(s)};var Z=(s,e)=>{for(var t in e)q(s,t,{get:e[t],enumerable:!0})},ee=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of X(e))!Y.call(s,i)&&i!==t&&q(s,i,{get:()=>e[i],enumerable:!(a=K(e,i))||a.enumerable});return s};var te=s=>ee(q({},"__esModule",{value:!0}),s);var B=(s,e,t)=>e.has(s)||V("Cannot "+t);var r=(s,e,t)=>(B(s,e,"read from private field"),t?t.call(s):e.get(s)),l=(s,e,t)=>e.has(s)?V("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),h=(s,e,t,a)=>(B(s,e,"write to private field"),a?a.call(s,t):e.set(s,t),t),p=(s,e,t)=>(B(s,e,"access private method"),t);var oe={};Z(oe,{LeaderChangedError:()=>N,PGliteWorker:()=>F,worker:()=>re});module.exports=te(oe);var se=()=>typeof document>"u"?new URL(`file:${__filename}`).href:document.currentScript&&document.currentScript.src||new URL("main.js",document.baseURI).href,Q=se();var de=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string";var j=()=>{if(globalThis.crypto?.randomUUID)return globalThis.crypto.randomUUID();let s=new Uint8Array(16);if(globalThis.crypto?.getRandomValues)globalThis.crypto.getRandomValues(s);else for(let t=0;t<s.length;t++)s[t]=Math.floor(Math.random()*256);s[6]=s[6]&15|64,s[8]=s[8]&63|128;let e=[];return s.forEach(t=>{e.push(t.toString(16).padStart(2,"0"))}),e.slice(0,4).join("")+"-"+e.slice(4,6).join("")+"-"+e.slice(6,8).join("")+"-"+e.slice(8,10).join("")+"-"+e.slice(10).join("")};var M,T,I,W,O,w,R,E,m,A,U,C,L,k,G,f,b,D,$,c,H,S,u,z,_=class _{constructor(e,t){l(this,c);l(this,M);l(this,T,0);l(this,I,!1);l(this,W,!1);l(this,O,!1);l(this,w,new EventTarget);l(this,R);l(this,E,!1);l(this,m);l(this,A);l(this,U);l(this,C);l(this,L);l(this,k);l(this,G);l(this,f,new Map);l(this,b,new Set);l(this,D);l(this,$,[]);h(this,m,e),h(this,R,j()),h(this,D,t?.extensions??{}),h(this,U,new Promise(a=>{r(this,m).addEventListener("message",i=>{if(i.data.type==="here")a();else throw new Error("Invalid message")},{once:!0})})),h(this,C,new Promise(a=>{let i=n=>{n.data.type==="ready"&&(h(this,A,n.data.id),r(this,m).removeEventListener("message",i),a())};r(this,m).addEventListener("message",i)})),h(this,M,p(this,c,H).call(this,t))}static async create(e,t){let a=new _(e,t);return await r(a,M),a}get waitReady(){return new Promise(async e=>{await r(this,M),r(this,E)?e():e(new Promise(t=>{r(this,w).addEventListener("connected",()=>{t()})}))})}get debug(){return r(this,T)}get ready(){return r(this,I)}get closed(){return r(this,W)}get isLeader(){return r(this,O)}async close(){var e;r(this,W)||(h(this,W,!0),r(this,L)?.close(),r(this,k)?.close(),(e=r(this,G))==null||e.call(this),r(this,m).terminate())}async[Symbol.asyncDispose](){await this.close()}async query(e,t,a){return await this.waitReady,await p(this,c,u).call(this,"query",e,t,a)}async exec(e,t){return await this.waitReady,await p(this,c,u).call(this,"exec",e,t)}async transaction(e){await this.waitReady;let t=await p(this,c,u).call(this,"transactionStart"),a;try{a=await e({query:async(i,n,y)=>await p(this,c,u).call(this,"transactionQuery",t,i,n,y),exec:async(i,n)=>await p(this,c,u).call(this,"transactionExec",t,i,n),rollback:async()=>{await p(this,c,u).call(this,"transactionRollback",t)},closed:!1})}catch(i){throw await p(this,c,u).call(this,"transactionRollback",t),i}return await p(this,c,u).call(this,"transactionCommit",t),a}async execProtocolRaw(e){return await this.waitReady,await p(this,c,u).call(this,"execProtocolRaw",e)}async execProtocol(e){return await this.waitReady,await p(this,c,u).call(this,"execProtocol",e)}async listen(e,t){return await this.waitReady,r(this,f).has(e)||r(this,f).set(e,new Set),r(this,f).get(e)?.add(t),await this.exec(`LISTEN ${e}`),async()=>{await this.unlisten(e,t)}}async unlisten(e,t){await this.waitReady,t?r(this,f).get(e)?.delete(t):r(this,f).delete(e),r(this,f).get(e)?.size===0&&await this.exec(`UNLISTEN ${e}`)}onNotification(e){return r(this,b).add(e),()=>{r(this,b).delete(e)}}offNotification(e){r(this,b).delete(e)}async dumpDataDir(){return await p(this,c,u).call(this,"dumpDataDir")}onLeaderChange(e){return r(this,w).addEventListener("leader-change",e),()=>{r(this,w).removeEventListener("leader-change",e)}}offLeaderChange(e){r(this,w).removeEventListener("leader-change",e)}};M=new WeakMap,T=new WeakMap,I=new WeakMap,W=new WeakMap,O=new WeakMap,w=new WeakMap,R=new WeakMap,E=new WeakMap,m=new WeakMap,A=new WeakMap,U=new WeakMap,C=new WeakMap,L=new WeakMap,k=new WeakMap,G=new WeakMap,f=new WeakMap,b=new WeakMap,D=new WeakMap,$=new WeakMap,c=new WeakSet,H=async function(e={}){for(let[o,x]of Object.entries(r(this,D))){if(x instanceof URL)throw new Error("URL extensions are not supported on the client side of a worker");{let d=await x.setup(this,{},!0);d.emscriptenOpts&&console.warn(`PGlite extension ${o} returned emscriptenOpts, these are not supported on the client side of a worker`),d.namespaceObj&&(this[o]=d.namespaceObj),d.bundlePath&&console.warn(`PGlite extension ${o} returned bundlePath, this is not supported on the client side of a worker`),d.init&&await d.init(),d.close&&r(this,$).push(d.close)}}await r(this,U);let{extensions:t,...a}=e;r(this,m).postMessage({type:"init",options:a}),await r(this,C);let i=`pglite-tab-close:${r(this,R)}`;h(this,G,await J(i));let n=`pglite-broadcast:${r(this,A)}`;h(this,L,new BroadcastChannel(n));let y=`pglite-tab:${r(this,R)}`;h(this,k,new BroadcastChannel(y)),r(this,L).addEventListener("message",async o=>{o.data.type==="leader-here"?(h(this,E,!1),r(this,w).dispatchEvent(new Event("leader-change")),p(this,c,S).call(this)):o.data.type==="notify"&&p(this,c,z).call(this,o.data.channel,o.data.payload)}),r(this,k).addEventListener("message",async o=>{o.data.type==="connected"&&(h(this,E,!0),r(this,w).dispatchEvent(new Event("connected")),h(this,T,await p(this,c,u).call(this,"getDebugLevel")),h(this,I,!0))}),r(this,m).addEventListener("message",async o=>{o.data.type==="leader-now"&&(h(this,O,!0),r(this,w).dispatchEvent(new Event("leader-change")))}),p(this,c,S).call(this)},S=async function(){r(this,E)||(r(this,L).postMessage({type:"tab-here",id:r(this,R)}),setTimeout(()=>p(this,c,S).call(this),16))},u=async function(e,...t){let a=j(),i={type:"rpc-call",callId:a,method:e,args:t};return r(this,k).postMessage(i),await new Promise((n,y)=>{let o=g=>{if(g.data.callId!==a)return;d();let v=g.data;if(v.type==="rpc-return")n(v.result);else if(v.type==="rpc-error"){let P=new Error(v.error.message);Object.assign(P,v.error),y(P)}else y(new Error("Invalid message"))},x=()=>{d(),y(new N)},d=()=>{r(this,k).removeEventListener("message",o),r(this,w).removeEventListener("leader-change",x)};r(this,w).addEventListener("leader-change",x),r(this,k).addEventListener("message",o)})},z=function(e,t){let a=r(this,f).get(e);if(a)for(let i of a)queueMicrotask(()=>i(t));for(let i of r(this,b))queueMicrotask(()=>i(e,t))};var F=_;async function re({init:s}){postMessage({type:"here"});let e=await new Promise(d=>{addEventListener("message",g=>{g.data.type==="init"&&d(g.data.options)},{once:!0})}),t=e.id??`${Q}:${e.dataDir??""}`;postMessage({type:"ready",id:t});let a=`pglite-election-lock:${t}`,i=`pglite-broadcast:${t}`,n=new BroadcastChannel(i),y=new Set;await J(a);let o=s(e);n.onmessage=async d=>{let g=d.data;switch(g.type){case"tab-here":ae(g.id,await o,y);break}},n.postMessage({type:"leader-here",id:t}),postMessage({type:"leader-now"}),(await o).onNotification((d,g)=>{n.postMessage({type:"notify",channel:d,payload:g})})}function ae(s,e,t){if(t.has(s))return;t.add(s);let a=`pglite-tab:${s}`,i=`pglite-tab-close:${s}`,n=new BroadcastChannel(a);navigator.locks.request(i,()=>new Promise(o=>{n.close(),t.delete(s),o()}));let y=ie(e);n.addEventListener("message",async o=>{let x=o.data;switch(x.type){case"rpc-call":let{callId:d,method:g,args:v}=x;try{let P=await y[g](...v);n.postMessage({type:"rpc-return",callId:d,result:P})}catch(P){console.error(P),n.postMessage({type:"rpc-error",callId:d,error:{message:P.message}})}break}}),n.postMessage({type:"connected"})}function ie(s){let e=new Map;return{async getDebugLevel(){return s.debug},async close(){await s.close()},async query(t,a,i){return await s.query(t,a,i)},async exec(t,a){return await s.exec(t,a)},async transactionStart(){let t=j(),{promise:a,resolve:i}=ne();return e.set(t,a),s.transaction(n=>new Promise((y,o)=>{i({tx:n,resolve:y,reject:o})})),t},async transactionCommit(t){if(!e.has(t))throw new Error("No transaction");(await e.get(t)).resolve(),e.delete(t)},async transactionQuery(t,a,i,n){if(!e.has(t))throw new Error("No transaction");return await(await e.get(t)).tx.query(a,i,n)},async transactionExec(t,a,i){if(!e.has(t))throw new Error("No transaction");return(await e.get(t)).tx.exec(a,i)},async transactionRollback(t){if(!e.has(t))throw new Error("No transaction");let a=await e.get(t);await a.tx.rollback(),a.reject(new Error("Transaction rolled back")),e.delete(t)},async execProtocol(t){return await s.execProtocol(t)},async execProtocolRaw(t){return await s.execProtocolRaw(t)},async dumpDataDir(){return await s.dumpDataDir()}}}var N=class extends Error{constructor(){super("Leader changed, pending operation in indeterminate state")}};async function J(s){let e;return await new Promise(t=>{navigator.locks.request(s,()=>new Promise(a=>{e=a,t()}))}),e}function ne(){let s,e;return{promise:new Promise((a,i)=>{s=a,e=i}),resolve:s,reject:e}}0&&(module.exports={LeaderChangedError,PGliteWorker,worker});
//# sourceMappingURL=index.cjs.map