import{a as Y,c as q,h as W}from"../../chunk-AYCEBHRG.js";import{d as s,e as u,f as g,g as c,h as C,i as P}from"../../chunk-ZYB3MGPW.js";P();P();P();var B={EBADF:8,EBADFD:127,EEXIST:20,EINVAL:28,EISDIR:31,ENODEV:43,ENOENT:44,ENOTDIR:54,ENOTEMPTY:55},m=class extends Error{constructor(t,r){super(r),typeof t=="number"?this.code=t:typeof t=="string"&&(this.code=B[t])}};var G=(A,t)=>{let r=A.FS,i={tryFSOperation(e){try{return e()}catch(n){throw n.code?n.code==="UNKNOWN"?new r.ErrnoError(B.EINVAL):new r.ErrnoError(n.code):n}},mount(e){return i.createNode(null,"/",16895,0)},syncfs(e,n,o){},createNode(e,n,o,d){if(!r.isDir(o)&&!r.isFile(o))throw new r.ErrnoError(28);let l=r.createNode(e,n,o);return l.node_ops=i.node_ops,l.stream_ops=i.stream_ops,l},getMode:function(e){return p("getMode",e),i.tryFSOperation(()=>t.lstat(e).mode)},realPath:function(e){let n=[];for(;e.parent!==e;)n.push(e.name),e=e.parent;return n.push(e.mount.opts.root),n.reverse(),n.join("/")},node_ops:{getattr(e){p("getattr",i.realPath(e));let n=i.realPath(e);return i.tryFSOperation(()=>{let o=t.lstat(n);return{...o,dev:0,ino:e.id,nlink:1,rdev:e.rdev,atime:new Date(o.atime),mtime:new Date(o.mtime),ctime:new Date(o.ctime)}})},setattr(e,n){p("setattr",i.realPath(e),n);var o=i.realPath(e);i.tryFSOperation(()=>{n.mode!==void 0&&t.chmod(o,n.mode),n.size!==void 0&&t.truncate(o,n.size),n.timestamp!==void 0&&t.utimes(o,n.timestamp,n.timestamp),n.size!==void 0&&t.truncate(o,n.size)})},lookup(e,n){p("lookup",i.realPath(e),n);let o=[i.realPath(e),n].join("/"),d=i.getMode(o);return i.createNode(e,n,d)},mknod(e,n,o,d){p("mknod",i.realPath(e),n,o,d);let l=i.createNode(e,n,o,d),h=i.realPath(l);return i.tryFSOperation(()=>(r.isDir(l.mode)?t.mkdir(h,{mode:o}):t.writeFile(h,"",{mode:o}),l))},rename(e,n,o){p("rename",i.realPath(e),i.realPath(n),o);let d=i.realPath(e),l=[i.realPath(n),o].join("/");i.tryFSOperation(()=>{t.rename(d,l)}),e.name=o},unlink(e,n){p("unlink",i.realPath(e),n);let o=[i.realPath(e),n].join("/");try{t.unlink(o)}catch{}},rmdir(e,n){p("rmdir",i.realPath(e),n);let o=[i.realPath(e),n].join("/");return i.tryFSOperation(()=>{t.rmdir(o)})},readdir(e){p("readdir",i.realPath(e));let n=i.realPath(e);return i.tryFSOperation(()=>t.readdir(n))},symlink(e,n,o){throw p("symlink",i.realPath(e),n,o),new r.ErrnoError(63)},readlink(e){throw p("readlink",i.realPath(e)),new r.ErrnoError(63)}},stream_ops:{open(e){p("open stream",i.realPath(e.node));let n=i.realPath(e.node);return i.tryFSOperation(()=>{r.isFile(e.node.mode)&&(e.shared.refcount=1,e.nfd=t.open(n))})},close(e){return p("close stream",i.realPath(e.node)),i.tryFSOperation(()=>{r.isFile(e.node.mode)&&e.nfd&&--e.shared.refcount===0&&t.close(e.nfd)})},dup(e){p("dup stream",i.realPath(e.node)),e.shared.refcount++},read(e,n,o,d,l){return p("read stream",i.realPath(e.node),o,d,l),d===0?0:i.tryFSOperation(()=>t.read(e.nfd,n,o,d,l))},write(e,n,o,d,l){return p("write stream",i.realPath(e.node),o,d,l),i.tryFSOperation(()=>t.write(e.nfd,n.buffer,o,d,l))},llseek(e,n,o){p("llseek stream",i.realPath(e.node),n,o);var d=n;if(o===1?d+=e.position:o===2&&r.isFile(e.node.mode)&&i.tryFSOperation(()=>{var l=t.fstat(e.nfd);d+=l.size}),d<0)throw new r.ErrnoError(28);return d},mmap(e,n,o,d,l){if(p("mmap stream",i.realPath(e.node),n,o,d,l),!r.isFile(e.node.mode))throw new r.ErrnoError(B.ENODEV);var h=A.mmapAlloc(n);return i.stream_ops.read(e,A.HEAP8,h,n,o),{ptr:h,allocated:!0}},msync(e,n,o,d,l){return p("msync stream",i.realPath(e.node),o,d,l),i.stream_ops.write(e,n,0,d,o),0}}};return i};function p(...A){}P();var te="state.txt",re="data",V={DIR:16384,FILE:32768},x,_,M,v,H,y,N,S,z,O,E,b,a,K,D,I,w,f,T,Q,$,X=class X{constructor({root:t,initialPoolSize:r,maintainedPoolSize:i}){u(this,a);u(this,x,!1);u(this,_);u(this,M);u(this,v);u(this,H);u(this,y);u(this,N,new Map);u(this,S,new Map);u(this,z,0);u(this,O,new Map);u(this,E,new Map);this.lastCheckpoint=0;this.checkpointInterval=1e3*60;this.poolCounter=0;u(this,b,new Set);this.root=t,this.initialPoolSize=r||1e3,this.maintainedPoolSize=i||100,this.readyPromise=c(this,a,K).call(this)}static async create(t){let r=new X(t);return await r.readyPromise,r}get ready(){return s(this,x)}async maintainPool(t){t=t||this.maintainedPoolSize;let r=t-this.state.pool.length,i=[];for(let e=0;e<r;e++)i.push(new Promise(async n=>{++this.poolCounter;let o=`${(Date.now()-1704063600).toString(16).padStart(8,"0")}-${this.poolCounter.toString(16).padStart(8,"0")}`,d=await s(this,v).getFileHandle(o,{create:!0}),l=await d.createSyncAccessHandle();s(this,N).set(o,d),s(this,S).set(o,l),c(this,a,I).call(this,{opp:"createPoolFile",args:[o]}),this.state.pool.push(o),n()}));for(let e=0;e>r;e--)i.push(new Promise(async n=>{let o=this.state.pool.pop();c(this,a,I).call(this,{opp:"deletePoolFile",args:[o]});let d=s(this,N).get(o);s(this,S).get(o)?.close(),await d.remove(),s(this,N).delete(o),s(this,S).delete(o),n()}));await Promise.all(i)}_createPoolFileState(t){this.state.pool.push(t)}_deletePoolFileState(t){let r=this.state.pool.indexOf(t);r>-1&&this.state.pool.splice(r,1)}async maybeCheckpointState(){Date.now()-this.lastCheckpoint>this.checkpointInterval&&await this.checkpointState()}async checkpointState(){let t=new TextEncoder().encode(JSON.stringify(this.state));s(this,y).truncate(0),s(this,y).write(t,{at:0}),s(this,y).flush(),this.lastCheckpoint=Date.now()}flush(){for(let t of s(this,b))try{t.flush()}catch{}s(this,b).clear()}exit(){for(let t of s(this,S).values())t.close();s(this,y).flush(),s(this,y).close()}chmod(t,r){c(this,a,D).call(this,{opp:"chmod",args:[t,r]},()=>{this._chmodState(t,r)})}_chmodState(t,r){let i=c(this,a,f).call(this,t);i.mode=r}close(t){let r=c(this,a,T).call(this,t);s(this,O).delete(t),s(this,E).delete(r)}fstat(t){let r=c(this,a,T).call(this,t);return this.lstat(r)}lstat(t){let r=c(this,a,f).call(this,t),i=r.type==="file"?s(this,S).get(r.backingFilename).getSize():0,e=4096;return{dev:0,ino:0,mode:r.mode,nlink:1,uid:0,gid:0,rdev:0,size:i,blksize:e,blocks:Math.ceil(i/e),atime:r.lastModified,mtime:r.lastModified,ctime:r.lastModified}}mkdir(t,r){c(this,a,D).call(this,{opp:"mkdir",args:[t,r]},()=>{this._mkdirState(t,r)})}_mkdirState(t,r){let i=c(this,a,w).call(this,t),e=i.pop(),n=[],o=this.state.root;for(let l of i){if(n.push(t),!o.children.hasOwnProperty(l))if(r?.recursive)this.mkdir(n.join("/"));else throw new m("ENOENT","No such file or directory");if(o.children[l].type!=="directory")throw new m("ENOTDIR","Not a directory");o=o.children[l]}if(o.children.hasOwnProperty(e))throw new m("EEXIST","File exists");let d={type:"directory",lastModified:Date.now(),mode:r?.mode||V.DIR,children:{}};o.children[e]=d}open(t,r,i){if(c(this,a,f).call(this,t).type!=="file")throw new m("EISDIR","Is a directory");let n=c(this,a,Q).call(this);return s(this,O).set(n,t),s(this,E).set(t,n),n}readdir(t){let r=c(this,a,f).call(this,t);if(r.type!=="directory")throw new m("ENOTDIR","Not a directory");return Object.keys(r.children)}read(t,r,i,e,n){let o=c(this,a,T).call(this,t),d=c(this,a,f).call(this,o);if(d.type!=="file")throw new m("EISDIR","Is a directory");return s(this,S).get(d.backingFilename).read(new Int8Array(r.buffer,i,e),{at:n})}rename(t,r){c(this,a,D).call(this,{opp:"rename",args:[t,r]},()=>{this._renameState(t,r,!0)})}_renameState(t,r,i=!1){let e=c(this,a,w).call(this,t),n=e.pop(),o=c(this,a,f).call(this,e.join("/"));if(!o.children.hasOwnProperty(n))throw new m("ENOENT","No such file or directory");let d=c(this,a,w).call(this,r),l=d.pop(),h=c(this,a,f).call(this,d.join("/"));if(i&&h.children.hasOwnProperty(l)){let F=h.children[l];s(this,S).get(F.backingFilename).truncate(0),this.state.pool.push(F.backingFilename)}h.children[l]=o.children[n],delete o.children[n]}rmdir(t){c(this,a,D).call(this,{opp:"rmdir",args:[t]},()=>{this._rmdirState(t)})}_rmdirState(t){let r=c(this,a,w).call(this,t),i=r.pop(),e=c(this,a,f).call(this,r.join("/"));if(!e.children.hasOwnProperty(i))throw new m("ENOENT","No such file or directory");let n=e.children[i];if(n.type!=="directory")throw new m("ENOTDIR","Not a directory");if(Object.keys(n.children).length>0)throw new m("ENOTEMPTY","Directory not empty");delete e.children[i]}truncate(t,r=0){let i=c(this,a,f).call(this,t);if(i.type!=="file")throw new m("EISDIR","Is a directory");let e=s(this,S).get(i.backingFilename);if(!e)throw new m("ENOENT","No such file or directory");e.truncate(r),s(this,b).add(e)}unlink(t){c(this,a,D).call(this,{opp:"unlink",args:[t]},()=>{this._unlinkState(t,!0)})}_unlinkState(t,r=!1){let i=c(this,a,w).call(this,t),e=i.pop(),n=c(this,a,f).call(this,i.join("/"));if(!n.children.hasOwnProperty(e))throw new m("ENOENT","No such file or directory");let o=n.children[e];if(o.type!=="file")throw new m("EISDIR","Is a directory");if(delete n.children[e],r){let d=s(this,S).get(o.backingFilename);d?.truncate(0),s(this,b).add(d),s(this,E).has(t)&&(s(this,O).delete(s(this,E).get(t)),s(this,E).delete(t))}this.state.pool.push(o.backingFilename)}utimes(t,r,i){c(this,a,D).call(this,{opp:"utimes",args:[t,r,i]},()=>{this._utimesState(t,r,i)})}_utimesState(t,r,i){let e=c(this,a,f).call(this,t);e.lastModified=i}writeFile(t,r,i){let e=c(this,a,w).call(this,t),n=e.pop(),o=c(this,a,f).call(this,e.join("/"));if(o.children.hasOwnProperty(n)){let h=o.children[n];h.lastModified=Date.now(),c(this,a,I).call(this,{opp:"setLastModified",args:[t,h.lastModified]})}else{if(this.state.pool.length===0)throw new Error("No more file handles available in the pool");let h={type:"file",lastModified:Date.now(),mode:i?.mode||V.FILE,backingFilename:this.state.pool.pop()};o.children[n]=h,c(this,a,I).call(this,{opp:"createFileNode",args:[t,h]})}let d=o.children[n],l=s(this,S).get(d.backingFilename);r.length>0&&(l.write(typeof r=="string"?new TextEncoder().encode(r):new Int8Array(r),{at:0}),t.startsWith("/pg_wal")&&s(this,b).add(l))}_createFileNodeState(t,r){let i=c(this,a,w).call(this,t),e=i.pop(),n=c(this,a,f).call(this,i.join("/"));n.children[e]=r;let o=this.state.pool.indexOf(r.backingFilename);return o>-1&&this.state.pool.splice(o,1),r}_setLastModifiedState(t,r){let i=c(this,a,f).call(this,t);i.lastModified=r}write(t,r,i,e,n){let o=c(this,a,T).call(this,t),d=c(this,a,f).call(this,o);if(d.type!=="file")throw new m("EISDIR","Is a directory");let l=s(this,S).get(d.backingFilename);if(!l)throw new m("EBADF","Bad file descriptor");let h=l.write(new Int8Array(r,i,e),{at:n});return o.startsWith("/pg_wal")&&s(this,b).add(l),h}};x=new WeakMap,_=new WeakMap,M=new WeakMap,v=new WeakMap,H=new WeakMap,y=new WeakMap,N=new WeakMap,S=new WeakMap,z=new WeakMap,O=new WeakMap,E=new WeakMap,b=new WeakMap,a=new WeakSet,K=async function(){g(this,_,await navigator.storage.getDirectory()),g(this,M,await c(this,a,$).call(this,this.root,{create:!0})),g(this,v,await c(this,a,$).call(this,re,{from:s(this,M),create:!0})),g(this,H,await s(this,M).getFileHandle(te,{create:!0})),g(this,y,await s(this,H).createSyncAccessHandle());let t=new ArrayBuffer(s(this,y).getSize());s(this,y).read(t,{at:0});let r,i=new TextDecoder().decode(t).split(`
`),e=!1;try{r=JSON.parse(i[0])}catch{r={root:{type:"directory",lastModified:Date.now(),mode:V.DIR,children:{}},pool:[]},s(this,y).truncate(0),s(this,y).write(new TextEncoder().encode(JSON.stringify(r)),{at:0}),e=!0}this.state=r;let n=i.slice(1).filter(Boolean).map(h=>JSON.parse(h));for(let h of n){let F=`_${h.opp}State`;if(typeof this[F]=="function")try{this[F](...h.args)}catch(k){console.warn("Error applying OPFS AHP WAL entry",h,k)}}let o=[],d=async h=>{if(h.type==="file")try{let F=await s(this,v).getFileHandle(h.backingFilename),k=await F.createSyncAccessHandle();s(this,N).set(h.backingFilename,F),s(this,S).set(h.backingFilename,k)}catch(F){console.error("Error opening file handle for node",h,F)}else for(let F of Object.values(h.children))o.push(d(F))};await d(this.state.root);let l=[];for(let h of this.state.pool)l.push(new Promise(async F=>{s(this,N).has(h)&&console.warn("File handle already exists for pool file",h);let k=await s(this,v).getFileHandle(h),ee=await k.createSyncAccessHandle();s(this,N).set(h,k),s(this,S).set(h,ee),F()}));await Promise.all([...o,...l]),await this.maintainPool(e?this.initialPoolSize:this.maintainedPoolSize),g(this,x,!0)},D=function(t,r){let i=c(this,a,I).call(this,t);try{r()}catch(e){throw s(this,y).truncate(i),e}},I=function(t){let r=JSON.stringify(t),i=new TextEncoder().encode(`
${r}`),e=s(this,y).getSize();return s(this,y).write(i,{at:e}),s(this,b).add(s(this,y)),e},w=function(t){return t.split("/").filter(Boolean)},f=function(t,r){let i=c(this,a,w).call(this,t),e=r||this.state.root;for(let n of i){if(e.type!=="directory")throw new m("ENOTDIR","Not a directory");if(!e.children.hasOwnProperty(n))throw new m("ENOENT","No such file or directory");e=e.children[n]}return e},T=function(t){let r=s(this,O).get(t);if(!r)throw new m("EBADF","Bad file descriptor");return r},Q=function(){let t=++C(this,z)._;for(;s(this,O).has(t);)C(this,z)._++;return t},$=async function(t,r){let i=c(this,a,w).call(this,t),e=r?.from||s(this,_);for(let n of i)e=await e.getDirectoryHandle(n,{create:r?.create});return e};var L=X;var R,j,Z=class extends Y{constructor(r,{initialPoolSize:i,maintainedPoolSize:e}={}){super(r);u(this,R);u(this,j);g(this,R,i??1e3),g(this,j,e??100)}async emscriptenOpts(r){return this.opfsAhp=await L.create({root:this.dataDir,initialPoolSize:s(this,R),maintainedPoolSize:s(this,j)}),{...r,preRun:[...r.preRun||[],e=>{let n=G(e,this.opfsAhp);e.FS.mkdir(W),e.FS.mount(n,{},W)}]}}async syncToFs(r,i=!1){await this.opfsAhp?.maybeCheckpointState(),await this.opfsAhp?.maintainPool(),i||this.opfsAhp?.flush()}async dumpTar(r,i){return q(r,i)}async close(r){this.opfsAhp?.exit(),r.quit()}};R=new WeakMap,j=new WeakMap;export{Z as OpfsAhpFS};
//# sourceMappingURL=index.js.map